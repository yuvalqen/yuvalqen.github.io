.. title: transaction-varna
.. slug: transaction-varna.html
.. date: 2022-08-09 20:47:39 UTC+03:00
.. tags:
.. category:
.. link:
.. description:
.. type: html
.. template: accounting-form.tmpl


<style>
  #main-form td {
    padding: 5px;
  }
  input.empty { background-color: white; }
  input.valid { background-color: rgba(0, 162, 80, 0.2); }
  input.invalid { background-color: rgba(163, 13, 13, 0.2); }
</style>

<form id="main-form"
  method="POST"
  action="https://script.google.com/macros/s/AKfycbwgqMmEu8nhkiUgcWySnbsfK8x2AWSnej8Hftw7tPVpjcmhxIhmGHB4sjsPok7H_5O9/exec"
>
  <table>
  {{% form_field name="Payer" type='input' %}}
  {{% form_field name="Type" type='input' %}}

  {{% form_field name="Asset" type='input' %}}
  {{% form_field name="Payee" type='input' %}}
  {{% form_field name="Expense" type='input' %}}
  {{% form_field name="Period Start" type='date' %}}
  {{% form_field name="Period End" type='date' %}}
  {{% form_field name="Offer" type='input' %}}

  {{% form_field name="Amount" type='number' %}}
  {{% form_field name="Currency" type='select' options='EUR,BGN' %}}
  {{% form_field name="Payment Date" type='date' %}}
  {{% form_field name="Comment" type='textarea' %}}
  <tr><td></td><td><button type="submit">Send</button></td></tr>
  </table>
</form>


<script type="text/javascript">
  function configureInput(input) {
    var awesomepleteForm = new Awesomplete(input, {
      minChars: 0,
      maxItems: 20,
      autoFirst: true,
      filter: function (text, input) {
          return (text.toLowerCase().indexOf(input.toLowerCase()) === 0) && (text.slice(0, -1).split('/').length === input.split('/').length);
      },
      replace: function (text) {
          this.input.value = text;
          console.log(this);
          var furtherOptions = this._list.filter(function (opt) { return (opt.toLowerCase().indexOf(text.toLowerCase()) === 0) && (opt.slice(0, -1).split('/').length === text.split('/').length) });
          if (furtherOptions.length === 1 && furtherOptions[0] != text) {
              this.replace(furtherOptions[0]);
          }
          updateInputs();
      },
      sort: function(a, b) {
          return a > b;
      }});

    input.addEventListener('awesomplete-selectcomplete', function (e) {
      if (e.text.value.slice(-1) == '/') {
        awesomepleteForm.open();
        awesomepleteForm.evaluate();
      }
      // document.querySelectorAll('div.date-picker.'+input.name.split('-')[0]).forEach(function(el) {
      //   el.style.display = e.text.value.slice(-22) == "/DD.MM.YYYY-DD.MM.YYYY" ? 'inline-block' : 'none'
      // });
      // document.querySelectorAll('div.date-picker').forEach(function (el) {
      //   el.querySelector('input').required = (el.style.display == 'none') ? false : true;
      // });
    });
    input.addEventListener('focus', function (e) {
      awesomepleteForm.open();
      awesomepleteForm.evaluate();
    });
    input.addEventListener('blur', function (e) {
      updateInputs();
    });

    return awesomepleteForm;
  }
  function composeDimension(dimension, data) {
    let res = {};
    for (let i = 0; i < data.length; i++) {
      res[data[i][dimension]] = data[i];
    }
    return res;
  }

  function updateRegularInput(input, display) {
    if (display) {
      input.closest('tr').style.display = 'table-row';
    } else {
      input.closest('tr').style.display = 'none';
      input.value = '';
    }
  }

  function updateAwesomepleInput(awesomeplete, options) {
    let final_options = [];
    for (let i = 0; i < options.length; i++) {
      const option_fragments = options[i].split('/');
      let partial_option = '';
      for (let j = 0; j < option_fragments.length; j++) {
        partial_option += option_fragments[j];
        if (j < option_fragments.length - 1) {
          partial_option += '/';
        }
        final_options.push(partial_option.slice());
      }
    }
    options = final_options.sort().filter(function(item, pos, ary) { // Deduplicates array values
        return !pos || item !== ary[pos - 1];
    });
    awesomeplete.list = options;

    if (options.length === 0) {
      awesomeplete.input.closest('tr').style.display = 'none';
      awesomeplete.input.value = '';
    } else {
      awesomeplete.input.closest('tr').style.display = 'table-row';
      if (options.length === 1 && awesomeplete.input.value === '') {
        awesomeplete.input.value = options[0];
      }
      awesomeplete.input.classList.remove('empty', 'invalid', 'valid');
      if (awesomeplete.input.value === '') {
        awesomeplete.input.classList.add('empty')
      } else if (options.indexOf(awesomeplete.input.value) >= 0) {
        awesomeplete.input.classList.add('valid')
      } else {
        awesomeplete.input.classList.add('invalid')
      }
    }
  }

  function getPayeeOptions() {
    const form_values = Object.fromEntries(new FormData(document.getElementById('main-form')));
    let res = [];
    switch (form_values.Type) {
      case 'Transfer': res = Object.keys(accounts); break;
      case 'Service': res = Object.keys(entities).filter(e => entities[e].Type !== 'Vendor'); break;
      case 'Offer': res = []; break;
      case 'Materials': res = Object.keys(entities).filter(e => entities[e].Type === 'Vendor'); break;
      case 'Lump Sum': res = []; break;
    }
    return res.filter(e => e !== form_values.Payer);
  }

  function getExpenseOptions() {
    const form_values = Object.fromEntries(new FormData(document.getElementById('main-form')));
    if (form_values.Payee === '' || form_values.Type !== 'Service') {
      return [];
    }

    return Object.values(expenses)
            .filter(e => e['Entity Type'].split(',').indexOf(entities[form_values.Payee].Type) >= 0)
            .filter(e => !e['Offer Mandatory'])
            .filter(e => form_values.Asset !== 'General' || e['General Allowed'])
            .map(e => e.Expense) || [''];
  }

  function getAssetOptions() {
    const form_values = Object.fromEntries(new FormData(document.getElementById('main-form')));
    if (form_values.Type === 'Transfer' || form_values.Type === '') {
      return [];
    }
    return ['General'].concat(Object.keys(assets));
  }

  function getOfferOptions() {
    const form_values = Object.fromEntries(new FormData(document.getElementById('main-form')));
    switch (form_values.Type) {
      case 'Offer':
        return Object.values(offers).filter(e => (e['Asset'] == form_values.Asset)).map(e => e.Offer);
      default:
        return [];
    }
  }
  function displayPeriod() {
    const form_values = Object.fromEntries(new FormData(document.getElementById('main-form')));
    return form_values.Type === 'Lump Sum' || expenses[form_values.Expense] && expenses[form_values.Expense]['Period based'];
  }
  function updateInputs() {
    updateAwesomepleInput(awesomepletes.payer, Object.keys(accounts));
    updateAwesomepleInput(awesomepletes.type, ['Service', 'Offer', 'Materials', 'Transfer', 'Lump Sum']);
    updateAwesomepleInput(awesomepletes.assets, getAssetOptions());
    updateAwesomepleInput(awesomepletes.payee, getPayeeOptions());
    updateAwesomepleInput(awesomepletes.offers, getOfferOptions());
    updateAwesomepleInput(awesomepletes.expense, getExpenseOptions());
    updateRegularInput(document.getElementById("field_Period Start"), displayPeriod());
    updateRegularInput(document.getElementById("field_Period End"), displayPeriod());
  }
  function initInputs() {
    window.awesomepletes = {
      type: configureInput(document.querySelector("#field_Type")),
      payer: configureInput(document.querySelector("#field_Payer")),
      payee:configureInput(document.querySelector("#field_Payee")),
      expense: configureInput(document.querySelector("#field_Expense")),
      assets: configureInput(document.querySelector("#field_Asset")),
      offers: configureInput(document.querySelector("#field_Offer")),
    };
    updateInputs();
  }

  function updateDates(el) {
      const form_values = Object.fromEntries(new FormData(document.getElementById('main-form')));

      const payment_date_input = document.getElementById('field_Payment Date');
      payment_date_input.classList.remove('empty', 'invalid', 'valid');
      payment_date_input.classList.add(form_values['Payment_Date'] === '' ? 'empty' : new Date(form_values['Payment Date']) < Date.now() ? 'valid': 'invalid');
      const period_start_input = document.getElementById('field_Period Start');
      const period_end_input = document.getElementById('field_Period End');
      period_start_input.classList.remove('empty', 'invalid', 'valid');
      period_end_input.classList.remove('empty', 'invalid', 'valid');
      const period_validity = form_values['Period Start'] === '' || form_values['Period End'] === '' ? 'empty' :
              new Date(form_values['Period Start']) <= new Date(form_values['Period End']) ? 'valid': 'invalid';
      period_start_input.classList.add(period_validity);
      period_end_input.classList.add(period_validity);
  }

  const main_form = document.getElementById('main-form');
  async function getInitialData() {
      const response = await fetch(main_form.action + '?method=getInitialData');
      const payload = await response.json();
      if (payload.result != 'success') {
        throw new Error('Failed to fetch initial data');
      }
      window.raw_data = payload.data;
  }

  window.addEventListener("load", function() {
    getInitialData().then(() => {
      window.expenses = composeDimension('Expense', raw_data['expenses']);
      window.assets = composeDimension('Asset', raw_data['assets']);
      window.offers = composeDimension('Offer', raw_data['offers']);
      window.entities = composeDimension('Entity', raw_data['entities']);
      window.accounts = composeDimension('Entity', raw_data['entities'].filter(e => e.Account));
      initInputs();
    });
  });
</script>


<!--<form id="transaction-form" autocomplete="off">-->
<!--<table>-->
<!--<tbody>-->
<!--<tr>-->
<!--<td align="left">Payer:</td>-->
<!--<td align="left">-->
<!--  <input tabindex="20" style="width: 100%;" name="payer" type="text" required autocomplete="off"/>-->
<!--  <div class="date-picker payer">-->
<!--    <label>Start Date</label><input tabindex="21" name="payer_startDate" type="date" onchange="updateDates(this)" required/>-->
<!--  </div>-->
<!--  <div class="date-picker payer">-->
<!--    <label>End Date</label><input tabindex="22" name="payer_endDate" type="date" onchange="updateDates(this)" required/>-->
<!--  </div>-->
<!--</td>-->
<!--</tr>-->
<!--<tr>-->
<!--<td align="left">Beneficiary:</td>-->
<!--<td align="left"><input tabindex="50" style="width: 100%;" name="beneficiary" type="text" required autocomplete="off"/>-->
<!--  <div class="date-picker beneficiary">-->
<!--    <label>Start Date</label><input tabindex="51" name="beneficiary_startDate" type="date" onchange="updateDates(this)"/>-->
<!--  </div>-->
<!--  <div class="date-picker beneficiary">-->
<!--    <label>End Date</label><input tabindex="52" name="beneficiary_endDate" type="date" onchange="updateDates(this)"/>-->
<!--  </div>-->
<!--</td>-->
<!--</tr>-->
<!--<tr>-->
<!--<td align="center"><input tabindex="60" value="Next" type="submit" /></td>-->
<!--<td style="width: 100%;"></td>-->
<!--</tr>-->
<!--</tbody>-->
<!--</table>-->
<!--</form>-->
<!--<script>-->
<!--function submitForm(e) {-->
<!--  e.preventDefault();-->
<!--  var payer = document.querySelector("form#transaction-form input[name^='payer-']").value;-->
<!--  var beneficiary = document.querySelector("form#transaction-form input[name^='beneficiary-']").value;-->
<!--  document.location = "https://docs.google.com/forms/d/e/1FAIpQLSesG5bE453SQ7-qyhtPW9PN6JQdPPdbeHBiWvm4VaQ15X_NVg/viewform?usp=pp_url&entry.771416493="+payer+"&entry.1622998056="+beneficiary;-->
<!--}-->

<!--function updateDates(input) {-->
<!--  regexToReplace = {-->
<!--    startDate: /[D0-9]{2}\.[M0-9]{2}\.[Y0-9]{4}-/i,-->
<!--    endDate: /-[D0-9]{2}\.[M0-9]{2}\.[Y0-9]{4}/i-->
<!--  };-->
<!--  if (input.value.length > 10 || input.value.length == 0) { return; }-->
<!--  var associatedInputName = input.name.split('-')[0].split('_')[0];-->
<!--  var startDateOrEndDate = input.name.split('-')[0].split('_')[1];-->
<!--  var dateString = (startDateOrEndDate == "endDate" ? "-" : "") + input.value.split('-').reverse().join('.') + (startDateOrEndDate == "startDate" ? "-" : "");-->
<!--  var associatedInput = document.querySelectorAll("input[name^='"+ associatedInputName +"-']")[0];-->
<!--  associatedInput.value = associatedInput.value.replace(regexToReplace[startDateOrEndDate], dateString);-->
<!--}-->
<!--function cartesian() {-->
<!--    var r = [], arg = arguments, max = arg.length-1;-->
<!--    function helper(arr, i) {-->
<!--        for (var j=0, l=arg[i].length; j<l; j++) {-->
<!--            var a = arr.slice(0); // clone arr-->
<!--            a.push(arg[i][j]);-->
<!--            if (i==max)-->
<!--                r.push(a);-->
<!--            else-->
<!--                helper(a, i+1);-->
<!--        }-->
<!--    }-->
<!--    helper([], 0);-->
<!--    return r.map(function(e) {return (e.join('').slice(0, -1).indexOf('//') >=0) ? "" : e.join('').replace('//', '/')}).filter(function (e) { return e.length > 0 });-->
<!--}-->
<!--var config = {-->
<!--  bills: ["Common Cost", "Electricity", "Gas", "Internet", "Management Fee", "Water", "Insurance", "Banking Fees", "Security", "Accounting", "Tax/Social Securities", "Tax/Property Tax", "Tax/VAT", "Tax/VAT-Refund"],-->
<!--  landlords: ["Holistic Solutions"],-->
<!--  expenses: ["Marketing", "Debt Write Off",-->
<!--             "Maintenance/", "Maintenance/Cleaning", "Maintenance/Gardening", "Maintenance/Swimming Pool", "Maintenance/Travel Costs", "Maintenance/Equipment", "Maintenance/Black Materials", "Maintenance/Furnitures", "Maintenance/Appliances", "Maintenance/Garbage Disposal",-->
<!--             "Legal Fees",-->
<!--             "Tax/", "Tax/Profit Tax", "Tax/Purchase Tax", "Tax/Tourist Tax",-->
<!--             "Renovation/", "Renovation/Management", "Renovation/Construction Labor", "Renovation/Worker Accomodations", "Renovation/Worker Personal Expenses", "Renovation/Electrician", "Renovation/Plumber", "Renovation/White Materials", "Renovation/Black Materials", "Renovation/Furnitures", "Renovation/Appliances", "Renovation/Accessories", "Renovation/Travel Costs", "Renovation/Assembly Labor", "Renovation/Cleaning Labor", "Renovation/Waste Disposal", "Renovation/Static Engineer", "Renovation/Utility Company Fees", "Renovation/Tools",-->
<!--             "Administration", "Purchase Cost", "Grants"],-->
<!--  employees: ["Amit", "Denitsa", "Joseph", "Yuval", "Rositsa", "Paysera", "Safe"],-->
<!--  assets: ["Sofia 7", "Pchelnik House", "Tundja 3", "General", "Pchelnik Ogosta", "Krivini House", "Plot Balam Dere Varna", "Pchelnik Vineyard 021038"],-->
<!--  tenant: ["Tenant"],-->
<!--  title: "Varna Transaction Submission Form"-->
<!--}-->
<!--var payerOptions = [].concat.apply([], [-->
<!--  cartesian(['Hospitality'], '/'),-->
<!--  cartesian(['Hospitality'], '/', config['assets'], '/'),-->
<!--  cartesian(['Hospitality'], '/', config['assets'], '/', ["DD.MM.YYYY-DD.MM.YYYY"]),-->
<!--  cartesian(config["tenant"], '/'),-->
<!--  cartesian(config["tenant"], '/', ['Deposit', 'Bills', 'Rent'], '/'),-->
<!--  cartesian(config["tenant"], '/', ['Deposit'], '/', config['assets']),-->
<!--  cartesian(config["tenant"], '/', ['Bills', 'Rent'], '/', config['assets'], '/'),-->
<!--  cartesian(config["tenant"], '/', ['Bills', 'Rent'], '/', config['assets'], '/', ["DD.MM.YYYY-DD.MM.YYYY"]),-->
<!--  config['landlords'],-->
<!--  config['employees']-->
<!--]);-->
<!--var beneficiaryOptions = [].concat.apply([], [-->
<!--  cartesian(config['bills'], '/'),-->
<!--  cartesian(config['bills'], '/', config['assets'], '/'),-->
<!--  cartesian(config['bills'], '/', config['assets'], '/', ["DD.MM.YYYY-DD.MM.YYYY"]),-->
<!--  cartesian(config['expenses'], '/'),-->
<!--  cartesian(config['expenses'], '/', config['assets']),-->
<!--  cartesian(config["tenant"], '/'),-->
<!--  cartesian(config["tenant"], '/', ['Deposit'], '/'),-->
<!--  cartesian(config["tenant"], '/', ['Deposit'], '/', config['assets']),-->
<!--  config['landlords'],-->
<!--  config['employees']-->
<!--]);-->
<!--var salt = Math.floor(Math.random()*10000000);-->
<!--document.querySelectorAll("form#transaction-form input").forEach(function (el) {-->
<!--      el.name = el.name + '-' + salt;-->
<!--    });-->
<!--configureInput(document.querySelector("form#transaction-form input[name^='payer-']"), payerOptions);-->
<!--configureInput(document.querySelector("form#transaction-form input[name^='beneficiary-']"), beneficiaryOptions);-->
<!--document.querySelector("form#transaction-form").addEventListener('submit', submitForm);-->
<!--</script>-->